<?xml version="1.0" encoding="utf-8"?>
<s:WindowedApplication 
    xmlns:fx="http://ns.adobe.com/mxml/2009" 
    xmlns:s="library://ns.adobe.com/flex/spark" 
    xmlns:mx="library://ns.adobe.com/flex/mx"
    showStatusBar="false">
    
    <fx:Declarations>
        <!-- Place non-visual elements (e.g., services, value objects) here -->
    </fx:Declarations>
    
    <fx:Script>
        <![CDATA[
            
            private var socket:DatagramSocket;
            
            private var targetIp:String;
            private var targetPort:int = 54321;
            
            private var localIp:String;
            private var localPort:int = 54321;
                        
            private function doConnect():void
            {
                socket = new DatagramSocket();
                socket.addEventListener(DatagramSocketDataEvent.DATA, onData);
                socket.bind(localPort, localIp);
                socket.receive();
                
                doSend("Hello");
            }
            
            private function doSend(msg:String):void
            {
                var data:ByteArray = new ByteArray();
                data.writeUTFBytes(msg);
                socket.send(data, 0, 0, targetIp, targetPort);
            }
            
            private function onConnectClick(e:MouseEvent):void
            {
                targetIp = otherIp.text;
                localIp = thisIp.text;
                doConnect();
            }
            
            private function addMessage(msg:String):void
            {
                chatLog.text += msg + "\n";
            }
            
            private function onData(e:DatagramSocketDataEvent):void
            {
                addMessage("Them: " + e.data.readUTFBytes(e.data.bytesAvailable));
            }
            
            private function onSend(s:MouseEvent):void
            {
                addMessage("Me: " + chatMsg.text);
                doSend(chatMsg.text);
                chatMsg.text = '';
            }
            
            private function onEnter():void
            {
                if (chatMsg.text.length > 0)
                {
                    onSend(null);
                }
            }
             
        ]]>
    </fx:Script>
    
    <s:layout>
        <s:VerticalLayout
            gap="12"
            paddingTop="12"
            paddingRight="12"
            paddingBottom="12"
            paddingLeft="12"/>
    </s:layout>
    
    <s:Label
        text="Other Computer Address"/>
    
    <s:TextInput
        id="otherIp"/>
    
    <s:Label
        text="This Computer Address"/>
    
    <s:TextInput
        id="thisIp"/>
    
    <s:Button
        id="connect"
        label="Connect"
        click="onConnectClick(event)"/>
    
    <s:Label
        text="Chat Log"/>
    
    <s:TextArea
        id="chatLog"
        width="100%"
        height="200"/>
    
    <s:Label
        text="Send This"/>
    
    <s:TextInput
        id="chatMsg"
        width="100%"
        enter="onEnter()"/>
    
    <s:Button
        id="send"
        label="Send"
        width="100%"
        click="onSend(event)"
        enabled="{chatMsg.text.length > 0}"/>
    
</s:WindowedApplication>
